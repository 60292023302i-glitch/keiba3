<!doctype html>
<html lang="ja">
<head>
  <meta charset="utf-8" />
  <title>ç«¶é¦¬äºˆæƒ³å¤§ä¼š â€” ç®¡ç†è€…ãƒšãƒ¼ã‚¸</title>
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <style>
    body { font-family: system-ui, -apple-system, "Segoe UI", Roboto, "Hiragino Kaku Gothic ProN", Meiryo, sans-serif; padding:20px; background:#f3f6fb; }
    h1 { margin-bottom:6px; }
    .panel { background:#fff; padding:12px; border-radius:10px; box-shadow:0 2px 8px rgba(0,0,0,0.06); margin-bottom:12px; }
    .horses { display:flex; gap:12px; flex-wrap:wrap; margin-top:10px; }
    .horse { padding:12px; width:160px; border-radius:8px; text-align:center; border:1px solid #eee; }
    .horse h3 { margin:0 0 8px 0; font-size:18px; }
    .counts { font-size:14px; color:#333; margin-bottom:8px; }
    button { cursor:pointer; padding:8px 10px; border-radius:8px; border:none; background:#1976d2; color:white; }
    button.reset { background:#e53935; }
    .small { font-size:13px; padding:6px 8px; }
    #log { font-size:13px; color:#444; white-space:pre-wrap; max-height:160px; overflow:auto; background:#fbfdff; padding:10px; border-radius:8px; border:1px solid #eef; margin-top:10px; }
  </style>
</head>
<body>
  <h1>ğŸ† ç®¡ç†è€…ãƒšãƒ¼ã‚¸ï¼ˆå‹ã¡é¦¬è¨­å®šãƒ»é›†è¨ˆãƒ»ãƒªã‚»ãƒƒãƒˆï¼‰</h1>

  <div class="panel">
    <div style="display:flex;align-items:center;gap:12px;">
      <div>
        <strong>ç¾åœ¨ã®å‹ã¡é¦¬ï¼š</strong>
        <span id="currentWinner">ï¼ˆæœªè¨­å®šï¼‰</span>
      </div>
      <div>
        <strong>åˆè¨ˆæŠ•ç¥¨è€…æ•°ï¼š</strong>
        <span id="totalVoters">0</span>
      </div>
      <div style="margin-left:auto;">
        <button id="refreshBtn" class="small">æ›´æ–°</button>
        <button id="resetBtn" class="small reset">å…¨ãƒªã‚»ãƒƒãƒˆï¼ˆæŠ•ç¥¨ãƒ»å‹ã¡é¦¬ã‚’ã‚¯ãƒªã‚¢ï¼‰</button>
      </div>
    </div>

    <div style="margin-top:8px;font-size:13px;color:#666;">
      â€»ã€Œãƒªã‚»ãƒƒãƒˆã€ã‚’æŠ¼ã™ã¨ Firebase ã® votes ã¨ winner ã‚’å‰Šé™¤ã—ã€reset ãƒ•ãƒ©ã‚°ã‚’çŸ­æ™‚é–“ true ã«ã—ã¾ã™ã€‚å‚åŠ è€…ã¯å†æŠ•ç¥¨å¯èƒ½ã«ãªã‚Šã¾ã™ã€‚
    </div>
  </div>

  <div class="panel">
    <div>
      <strong>ãƒ¬ãƒ¼ã‚¹é¦¬ä¸€è¦§ï¼ˆç¥¨æ•°ï¼‰</strong>
    </div>
    <div id="counts" class="horses"></div>
    <div id="log" aria-live="polite">ãƒ­ã‚°ï¼š</div>
  </div>

  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/9.22.1/firebase-app.js";
    import {
      getDatabase, ref, set, remove, onValue, get
    } from "https://www.gstatic.com/firebasejs/9.22.1/firebase-database.js";

    const firebaseConfig = {
      apiKey: "AIzaSyA3E3Ls71E8AZqabdKDboohTaSVZY0MjdA",
      authDomain: "keiba-f3b7c.firebaseapp.com",
      databaseURL: "https://keiba-f3b7c-default-rtdb.asia-southeast1.firebasedatabase.app",
      projectId: "keiba-f3b7c",
      storageBucket: "keiba-f3b7c.firebasestorage.app",
      messagingSenderId: "691422686915",
      appId: "1:691422686915:web:b9d29c086eeed69591bc76",
      measurementId: "G-4DVFB5ZZXG"
    };

    const app = initializeApp(firebaseConfig);
    const db = getDatabase(app);

    const horses = ["é¦¬åˆºã—", "ã‚†ãŸã½ã‚“", "å±±æœ¬"];

    const countsDiv = document.getElementById("counts");
    const logDiv = document.getElementById("log");
    const currentWinnerSpan = document.getElementById("currentWinner");
    const refreshBtn = document.getElementById("refreshBtn");
    const resetBtn = document.getElementById("resetBtn");
    const totalVotersSpan = document.getElementById("totalVoters");

    function log(msg) {
      const t = new Date().toLocaleTimeString();
      logDiv.textContent = `[${t}] ${msg}\n` + logDiv.textContent;
    }

    const votesRef = ref(db, "votes");
    const winnerRef = ref(db, "winner");

    // votes ã‚’ãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ ç›£è¦–ï¼ˆåˆè¨ˆãƒ»å„é¦¬ã‚«ã‚¦ãƒ³ãƒˆï¼‰
    onValue(votesRef, snapshot => {
      const counts = {};
      horses.forEach(h => counts[h] = 0);

      snapshot.forEach(child => {
        const v = child.val();
        if (v && v.horse && counts.hasOwnProperty(v.horse)) counts[v.horse]++;
      });

      const total = snapshot.size || 0;
      renderCounts(counts);
      totalVotersSpan.textContent = total;
      log(`æŠ•ç¥¨ãƒ‡ãƒ¼ã‚¿æ›´æ–°ï¼ˆåˆè¨ˆ ${total} ä»¶ï¼‰ã€‚`);
    });

    // winner ã®ç›£è¦–
    onValue(winnerRef, snapshot => {
      if (snapshot.exists()) {
        const w = snapshot.val();
        currentWinnerSpan.textContent = w;
        log(`å‹ã¡é¦¬ãŒ "${w}" ã«è¨­å®šã•ã‚Œã¾ã—ãŸã€‚`);
      } else {
        currentWinnerSpan.textContent = "ï¼ˆæœªè¨­å®šï¼‰";
        log("å‹ã¡é¦¬ã¯æœªè¨­å®šã§ã™ã€‚");
      }
    });

    function renderCounts(counts) {
      countsDiv.innerHTML = horses.map(h => {
        const num = counts[h] ?? 0;
        return `
          <div class="horse">
            <h3>${h}</h3>
            <div class="counts">ç¥¨æ•°: ${num}</div>
            <div style="display:flex;gap:6px;justify-content:center;">
              <button data-horse="${h}" class="small setWinner">å‹ã¡é¦¬ã«è¨­å®š</button>
            </div>
          </div>
        `;
      }).join("");

      document.querySelectorAll(".setWinner").forEach(btn => {
        btn.onclick = async () => {
          const h = btn.dataset.horse;
          if (!confirm(`æœ¬å½“ã«ã€Œ${h}ã€ã‚’å‹ã¡é¦¬ã«è¨­å®šã—ã¾ã™ã‹ï¼Ÿ`)) return;
          try {
            await set(winnerRef, h);
            await set(ref(db, "reset"), false);
            log(`å‹ã¡é¦¬ã‚’ "${h}" ã«è¨­å®šã—ã¾ã—ãŸã€‚`);
            alert(`å‹ã¡é¦¬ã‚’ã€Œ${h}ã€ã«è¨­å®šã—ã¾ã—ãŸã€‚`);
          } catch (err) {
            console.error(err);
            alert("å‹ã¡é¦¬è¨­å®šã§ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸã€‚");
          }
        };
      });
    }

    // æ‰‹å‹•æ›´æ–°ãƒœã‚¿ãƒ³ï¼ˆè£œåŠ©ï¼‰
    refreshBtn.addEventListener("click", () => {
      get(votesRef).then(() => log("æ‰‹å‹•æ›´æ–°ã‚’å®Ÿè¡Œã—ã¾ã—ãŸã€‚")).catch(e => log("æ‰‹å‹•æ›´æ–°ã‚¨ãƒ©ãƒ¼: " + e));
    });

    // ãƒªã‚»ãƒƒãƒˆå‡¦ç†
    resetBtn.addEventListener("click", async () => {
      if (!confirm("æœ¬å½“ã«å…¨æŠ•ç¥¨ã¨å‹ã¡é¦¬ã‚’ã‚¯ãƒªã‚¢ã—ã¦å†æŠ•ç¥¨å¯èƒ½ã«ã—ã¾ã™ã‹ï¼Ÿ")) return;
      try {
        await set(ref(db, "reset"), true);
        log("reset ãƒ•ãƒ©ã‚°ã‚’ true ã«ã—ã¾ã—ãŸã€‚");

        await remove(votesRef);
        await remove(winnerRef);
        log("votes ã¨ winner ã‚’å‰Šé™¤ã—ã¾ã—ãŸã€‚");

        // çŸ­æ™‚é–“ã ã‘ reset=true ã«ã—ã¦ã‹ã‚‰ false ã«æˆ»ã™
        setTimeout(async () => {
          try {
            await set(ref(db, "reset"), false);
            log("reset ãƒ•ãƒ©ã‚°ã‚’ false ã«æˆ»ã—ã¾ã—ãŸã€‚");
          } catch (e) {
            console.error(e);
            log("reset ãƒ•ãƒ©ã‚°ã®æˆ»ã—ã«å¤±æ•—: " + e);
          }
        }, 1500);

        alert("ãƒªã‚»ãƒƒãƒˆå‡¦ç†ã‚’å®Ÿè¡Œã—ã¾ã—ãŸã€‚å‚åŠ è€…ã¯è‡ªå‹•åæ˜ ã¾ãŸã¯ãƒšãƒ¼ã‚¸å†èª­ã¿è¾¼ã¿ã§å†æŠ•ç¥¨å¯èƒ½ã«ãªã‚Šã¾ã™ã€‚");
      } catch (err) {
        console.error(err);
        alert("ãƒªã‚»ãƒƒãƒˆä¸­ã«ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸã€‚");
      }
    });

    log("ç®¡ç†è€…ãƒšãƒ¼ã‚¸ã‚’èª­ã¿è¾¼ã¿ã¾ã—ãŸã€‚ãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ ã§æŠ•ç¥¨ã‚’ç›£è¦–ã—ã¾ã™ã€‚");
  </script>
</body>
</html>
